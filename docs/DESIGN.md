# 防護具照合チェックアプリ 設計ドキュメント

## 開発背景

### 課題
原瀬川橋塗替塗装工事において、防護具（防護服・手袋・吸収缶）の使用数を照合する作業が発生。

- **チェックシート（PDF）**: 各業者が提出する手書きの使用記録（週単位、1ページ=1週間）
- **Excel集計表**: 日ごとの使用数を記録した管理表

この2つのデータを日ごとに突合し、一致しているか確認する必要がある。

### 問題点
1. **手作業の負担**: 複数社分のPDFを切り替えながら目視確認 → 時間がかかる
2. **エラー見落としリスク**: 単純作業の繰り返しで注意力低下
3. **フォーマットの複雑さ**: PDFは作業員ごとに防護服・手袋・吸収缶が縦に繰り返される構造

---

## 検討した仕様

| 方式 | 概要 | メリット | デメリット |
|------|------|----------|------------|
| **A. 完全手動** | 目視で照合 | 確実 | 時間がかかる、見落としリスク |
| **B. 半自動アプリ** | PDF見ながら人間が入力→自動照合 | バランス良い | 入力の手間は残る |
| **C. OCR完全自動** | 手書き文字を自動認識 | 最速（動けば） | 手書き認識精度が不安定 |

### 採用: B. 半自動アプリ

**理由**:
- 手書き数字のOCR精度は不安定（特に小さい数字、枠線との重なり）
- 人間が読んで入力 → 自動で照合・ハイライトが現実的
- 結果的に作業時間を大幅短縮できる

---

## 採用した仕様

### データ対応表

| PDFチェックシート | Excelシート |
|------------------|-------------|
| 防護服 | 防護服 |
| 手袋 | 防護手袋 |
| 吸収缶 | フィルター |

### 照合ルール

```
日付ごとに:
  (さくら塗装のPDF該当日の✓数) 
  + (竹内塗装のPDF該当日の✓数) 
  + (リバーランズのPDF該当日の✓数)
  = 3社合計

  ↓ 比較

  Excelの該当日「使用」列の値

  → 一致: OK
  → 不一致: 要確認
```

---

## 画面構成

### 画面1: 初期設定画面

```
┌─────────────────────────────────────────┐
│  防護具照合チェック - 初期設定          │
├─────────────────────────────────────────┤
│                                         │
│  業者数: [3 ▼]                          │
│                                         │
│  業者1: [さくら塗装    ] [PDF選択]      │
│  業者2: [竹内塗装      ] [PDF選択]      │
│  業者3: [リバーランズ  ] [PDF選択]      │
│                                         │
│  Excel: [ファイル選択]                  │
│                                         │
│  [読み込み開始]                         │
│                                         │
└─────────────────────────────────────────┘
```

**機能**:
- 業者数を1〜5社で選択可能
- 各業者名を入力
- 各業者のPDFをアップロード
- Excel集計表をアップロード
- 読み込み開始で一覧画面へ遷移

---

### 画面2: 一覧画面

```
┌─────────────────────────────────────────────────┐
│  原瀬川橋 防護具照合チェック      [PDF出力]     │
├──────────┬──────┬──────┬──────┬─────────────────┤
│  日付     │防護服│手袋  │吸収缶│ 状態            │
├──────────┼──────┼──────┼──────┼─────────────────┤
│  10/06   │  ✓   │  ✓   │  ✓   │  OK            │
│  10/07   │  ✓   │  ⚠   │  ✓   │  要確認        │
│  10/08   │      │      │      │  （未確認）     │
│  10/09   │      │      │      │  （未確認）     │
│  ...     │      │      │      │                │
└──────────┴──────┴──────┴──────┴─────────────────┘
           ↑ クリックで詳細画面へ
```

**機能**:
- Excelから日付を読み取り一覧表示
- 各日付の照合状態を表示
  - OK: 全項目一致
  - 要確認: 1つ以上不一致
  - 空欄: 未確認
- 行クリックで詳細画面へ遷移
- PDF出力ボタンで結果をPDF化

---

### 画面3: 詳細画面（日付別）

```
┌─────────────────────────────────────────────────────────┐
│  ← 一覧に戻る          2025/10/07                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │さくら塗装│  │竹内塗装  │  │リバーランズ│              │
│  │          │  │          │  │          │              │
│  │ (PDF     │  │ (PDF     │  │ (PDF     │              │
│  │  該当日  │  │  該当日  │  │  該当日  │              │
│  │  表示)   │  │  表示)   │  │  表示)   │              │
│  │          │  │          │  │          │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  ■防護服（黄）  ■手袋（青）  ■吸収缶（緑）             │
│                                                         │
│            さくら   竹内   リバー  │ 合計  │ Excel │結果│
│  ─────────────────────────────────┼───────┼───────┼────│
│  防護服     [ 5 ]  [ 4 ]  [ 3 ]   │  12   │  12   │ ✓  │
│  手袋       [ 5 ]  [ 3 ]  [ 2 ]   │  10   │  11   │ ⚠  │
│  吸収缶     [ 4 ]  [ 2 ]  [ 2 ]   │   8   │   8   │ ✓  │
│                                                         │
├─────────────────────────────────────────────────────────┤
│  [← 前の日]                    [次の日 →]    [保存]     │
└─────────────────────────────────────────────────────────┘
```

**機能**:
- 該当日付のPDFを3社横並びで表示
- 項目ごとに色分け（視認性向上）
  - 黄色: 防護服
  - 青色: 手袋
  - 緑色: 吸収缶
- 各社×各項目の入力欄
- 自動で合計計算
- Excelの値を表示
- 照合結果を表示（✓ or ⚠）
- 前の日/次の日で移動可能
- 保存ボタンで入力内容を保持

---

## PDF日付読み取りについて

PDFの日付部分（印字）はOCRで読み取りを試みる。

**読み取り失敗時のフロー**:
1. 「この日付を入力してください」とダイアログ表示
2. ユーザーが手動で日付入力
3. 以降はその対応で処理

---

## データフロー

```
[初期設定]
    │
    ├── PDFアップロード（各業者）
    │       └── PDF.js で読み込み・ページ画像化
    │
    ├── Excelアップロード
    │       └── SheetJS で読み込み
    │       └── 日付一覧抽出
    │       └── 各日付の「使用」数取得
    │
    ▼
[一覧画面]
    │
    ├── 日付一覧表示
    ├── 各日付の状態表示
    │
    ▼ （日付クリック）
    
[詳細画面]
    │
    ├── PDF該当ページ表示
    ├── ユーザー入力
    ├── 自動照合
    ├── 結果表示
    │
    ▼ （保存）

[データ保持: localStorage]
    │
    ▼ （PDF出力）

[結果PDF生成: jsPDF]
```

---

## 技術スタック

| 用途 | ライブラリ |
|------|-----------|
| フレームワーク | Next.js (App Router) |
| PDF表示 | PDF.js (pdfjs-dist) |
| Excel読み込み | SheetJS (xlsx) |
| PDF出力 | jsPDF |
| スタイリング | Tailwind CSS |
| デプロイ | Vercel |

---

## 拡張性メモ

### 業者数の可変対応
- 初期設定で1〜5社選択可能
- UI・ロジックは動的に対応

### Excelフォーマット変更への対応（将来）
- 現状は原瀬川橋のExcel固定
- 将来的には以下を設定可能にすることも検討
  - 日付列の位置
  - 使用数列の位置
  - シート名

---

## ファイル構成（予定）

```
bougu-check-app/
├── docs/
│   └── DESIGN.md          # 本ドキュメント
├── src/
│   ├── app/
│   │   ├── page.tsx       # 初期設定画面
│   │   ├── list/
│   │   │   └── page.tsx   # 一覧画面
│   │   └── detail/
│   │       └── [date]/
│   │           └── page.tsx  # 詳細画面
│   ├── components/
│   │   ├── PdfViewer.tsx
│   │   ├── InputTable.tsx
│   │   └── ...
│   ├── lib/
│   │   ├── pdfUtils.ts
│   │   ├── excelUtils.ts
│   │   └── storageUtils.ts
│   └── types/
│       └── index.ts
├── public/
├── package.json
└── README.md
```

---

## 実際の構成（2026/01/16時点）

### 当初構想との差分

上記の設計（PDF3社横並び表示、日付別詳細画面）は実装を断念し、以下の構成に変更した。

**断念した理由**
- PDFの「どこが該当日の列か」を特定するにはOCRが必要
- 手書き＋複雑なフォーマット → OCR精度が期待できない
- 納期が当日中だったため、深追いせず別アプローチに切り替え

### 採用した構成（2ツール分離方式）

```
┌─────────────────────────────────────────────────────────┐
│  【ツール1】オーバーレイツール（overlay-tool-v4.html）   │
│  ─────────────────────────────────────────────────────  │
│  - PDFを読み込んで表示                                  │
│  - 色付きの線をオーバーレイして✓を数えやすくする        │
│  - 会社タブで切り替え                                   │
│  - 人間が目で見て✓を数える                             │
└─────────────────────────────────────────────────────────┘
        ↓ 数えた数値を手入力
┌─────────────────────────────────────────────────────────┐
│  【ツール2】Next.jsアプリ（bougu-check-app）            │
│  ─────────────────────────────────────────────────────  │
│  - Excelを読み込み                                      │
│  - 週単位のテーブルで数値入力                           │
│  - 3社合計 vs Excel値を自動照合                         │
│  - 結果をPDF出力                                        │
└─────────────────────────────────────────────────────────┘
```

### 実際のファイル構成

```
bougu-check-app/
├── docs/
│   └── DESIGN.md              # 本ドキュメント
├── src/
│   ├── app/
│   │   ├── page.tsx           # ホーム画面（業者登録・Excel読込）
│   │   ├── input/
│   │   │   └── page.tsx       # 入力画面（週単位テーブル）
│   │   ├── summary/
│   │   │   └── page.tsx       # 集計画面（照合結果・PDF出力）
│   │   ├── layout.tsx
│   │   └── globals.css
│   ├── context/
│   │   └── AppContext.tsx     # 状態管理（localStorage自動保存）
│   └── lib/
│       └── excelUtils.ts      # Excel読み込み
├── package.json
└── README.md

overlay-tool-v4.html           # 別ファイル（単体HTML）
```

### 実際の画面構成

#### ホーム画面（/）
- 業者登録（デフォルト：さくら塗装、竹内塗装、リバーランズ）
- Excel集計表の読み込み
- 前回データがあれば「続きから再開」ボタン表示

#### 入力画面（/input）
- 業者タブ：クリックで切り替え
- 週タブ：月〜金の5日間単位
- 入力テーブル：日付（横）× 項目（縦：防護服/手袋/吸収缶）
- データがない日は「-」でグレーアウト

#### 集計画面（/summary）
- 照合結果一覧（入力値 vs Excel値）
- ステータス：✓OK / ⚠要確認 / -未入力
- ⚠にホバーで内訳表示（さ5 / 竹3 / リ2）
- PDF出力ボタン

### メリット・デメリット

**メリット**
- OCR不要で確実に動作
- PDFビューアの実装コストを回避
- オーバーレイツールは単体HTMLなのでどこでも動く

**デメリット**
- 2つのツールを行き来する手間
- PDFと入力画面が別ウィンドウ

---

## デプロイ・使い方

### フォルダ構成

```
bougu-check-app/
├── docs/
│   ├── DESIGN.md                    # 設計書（本ファイル）
│   └── bougu-app-documentation.md   # 解説書
├── tools/
│   └── overlay-tool-v4.html         # オーバーレイツール
├── src/
│   └── ...（Next.jsのコード）
└── package.json
```

### Next.jsアプリのデプロイ

**Vercelにデプロイ**
```bash
cd bougu-check-app
npm install
npm run build
vercel deploy
```

または GitHub連携で自動デプロイ。

**ローカルで動かす場合**
```bash
cd bougu-check-app
npm install
npm run dev
# http://localhost:3000 で開く
```

### オーバーレイツールの使い方

`tools/overlay-tool-v4.html` は単体HTMLファイル。

**使い方**
1. HTMLファイルをダブルクリックしてブラウザで開く
2. または、任意のWebサーバーで配信

**注意**
- Next.jsアプリとは別物（Vercelにデプロイしない）
- ローカルで直接開いて使う想定

---

## データ保存について

### 現状の仕組み

- **localStorage**（ブラウザのローカルストレージ）に自動保存
- 保存キー: `bougu-check-data`
- Vercelにデプロイしてもデータは消えない

### localStorageの特徴

| 項目 | 内容 |
|------|------|
| 保存場所 | ブラウザ内（デバイスごと） |
| 容量 | 約5MB（十分） |
| 永続性 | キャッシュクリアしない限り残る |
| 共有 | 同じブラウザ・同じデバイスのみ |

### 困るケース

- 別のPCで作業したい → データがない
- ブラウザのキャッシュをクリア → 消える
- 同僚とデータ共有したい → できない

### 将来の拡張案（Firebase）

上記が問題になったら、Firebase Firestoreの導入を検討。

**Firebaseを使うと**
- どのデバイスからでもアクセス可能
- データが永続化される
- 複数人で共有も可能

**導入に必要な作業**
- Firebaseプロジェクト作成
- Googleログイン実装（誰のデータか識別するため）
- Firestoreへの読み書き処理追加

**コスト**
- 無料枠（Spark Plan）で十分な規模

**判断基準**
- 1人・1台で使う → localStorage で十分
- 複数デバイス or 複数人 → Firebase 検討

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026/01/16 | 初版作成 |
| 2026/01/19 | 実際の構成（2ツール分離方式）を追記 |
