# 防護具照合チェックシステム 解説書

## 概要

このシステムは「防護具の使用数チェック」を効率化するためのツール群。手書きのチェックシートPDFとExcel集計表の値を照合する作業を支援する。

**システム構成**
- **Next.jsアプリ（bougu-check-app）**: 数値入力と照合結果の管理
- **オーバーレイツール（overlay-tool-v4.html）**: PDFの✓を数えやすくする補助ツール

---

## 当初の構想と実際の構成

### 当初やりたかったこと

```
┌─────────────────────────────────────────────────────────┐
│  ← 一覧に戻る          2025/10/07                       │
├─────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │さくら塗装│  │竹内塗装  │  │リバーランズ│              │
│  │ (10/7の  │  │ (10/7の  │  │ (10/7の  │              │
│  │  PDF部分 │  │  PDF部分 │  │  PDF部分 │              │
│  │  だけ)   │  │  だけ)   │  │  だけ)   │              │
│  └──────────┘  └──────────┘  └──────────┘              │
├─────────────────────────────────────────────────────────┤
│            さくら   竹内   リバー  │ 合計  │ Excel │結果│
│  防護服     [ 5 ]  [ 4 ]  [ 3 ]   │  12   │  12   │ ✓  │
│  手袋       [ 5 ]  [ 3 ]  [ 2 ]   │  10   │  11   │ ⚠  │
│  吸収缶     [ 4 ]  [ 2 ]  [ 2 ]   │   8   │   8   │ ✓  │
└─────────────────────────────────────────────────────────┘
```

**理想の動作**
1. PDFをアップロード
2. 1ページ（月〜金の5日分）から該当日の列だけ自動で切り出し
3. 3社分を横並び表示
4. その場で数値入力 → 照合

### 断念した理由

- PDFの「どこが10/6の列か」を特定するにはOCRが必要
- 手書き＋複雑なフォーマット → OCR精度が期待できない
- 納期が当日中だったため、深追いせず別アプローチに切り替え

### 実際の構成（2ツール分離方式）

```
┌─────────────────────────────────────────────────────────┐
│  【ツール1】オーバーレイツール（HTML単体）               │
│  ─────────────────────────────────────────────────────  │
│  - PDFを読み込んで表示                                  │
│  - 色付きの線をオーバーレイして✓を数えやすくする        │
│  - 会社タブで切り替え                                   │
│  - 人間が目で見て✓を数える                             │
└─────────────────────────────────────────────────────────┘
        ↓ 数えた数値を手入力
┌─────────────────────────────────────────────────────────┐
│  【ツール2】Next.jsアプリ                               │
│  ─────────────────────────────────────────────────────  │
│  - Excelを読み込み                                      │
│  - 週単位のテーブルで数値入力                           │
│  - 3社合計 vs Excel値を自動照合                         │
│  - 結果をPDF出力                                        │
└─────────────────────────────────────────────────────────┘
```

**メリット**
- OCR不要で確実に動作
- PDFビューアの実装コストを回避
- オーバーレイツールは単体HTMLなのでどこでも動く

**デメリット**
- 2つのツールを行き来する手間
- PDFと入力画面が別ウィンドウ

---

## 作業の流れ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  1. オーバーレイ  │ →  │  2. 入力画面     │ →  │  3. 集計画面     │
│  ツールでPDF確認  │    │  で数値を入力    │    │  で照合・PDF出力  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

---

## 1. オーバーレイツール（overlay-tool-v4.html）

### 目的
チェックシートPDFに色付きの線（オーバーレイ）を重ねて、防護服・手袋・吸収缶の行を視覚的に区別しやすくする。

### 主な機能

| 機能 | 説明 |
|------|------|
| 会社タブ | 複数会社のPDFを切り替えて表示 |
| 項目ボタン | 防護服（黄）/ 手袋（青）/ 吸収缶（緑）で色分け |
| 人数設定 | チェックシートの作業員数に合わせて線の本数を調整 |
| 位置調整 | ↑↓キーまたは数値入力で線の位置を微調整 |
| ページ送り | ←→キーでPDFのページを移動 |

### キーボードショートカット

| キー | 動作 |
|------|------|
| 1, 2, 3, 4 | 会社タブ切り替え |
| Q, W, E | 防護服 / 手袋 / 吸収缶 切り替え |
| ↑ / ↓ | 線の位置を1pxずつ調整 |
| ← / → | PDFページ移動 |
| Ctrl+V | クリップボードから画像貼り付け |

### 使い方
1. HTMLファイルをブラウザで開く
2. 会社タブを選択してPDFをドラッグ&ドロップ
3. 人数を設定
4. 項目ボタンで色を切り替えながら✓の数を数える
5. Next.jsアプリの入力画面に数値を入力

---

## 2. Next.jsアプリ（bougu-check-app）

### 技術スタック
- Next.js 14（App Router）
- TypeScript
- Tailwind CSS
- xlsx（Excel読み込み）

### ファイル構成

```
bougu-check-app/
├── src/
│   ├── app/
│   │   ├── page.tsx          # ホーム画面
│   │   ├── input/page.tsx    # 入力画面
│   │   ├── summary/page.tsx  # 集計画面
│   │   ├── layout.tsx        # 共通レイアウト
│   │   └── globals.css       # グローバルスタイル
│   ├── context/
│   │   └── AppContext.tsx    # 状態管理（Context API）
│   └── lib/
│       └── excelUtils.ts     # Excel読み込みユーティリティ
├── docs/
│   └── DESIGN.md             # 設計書
└── package.json
```

### 画面説明

#### ホーム画面（/）
- 業者登録（デフォルト：さくら塗装、竹内塗装、リバーランズ）
- Excel集計表の読み込み
- 前回データがあれば「続きから再開」ボタン表示

#### 入力画面（/input）
- 業者タブ：クリックで切り替え
- 週タブ：月〜金の5日間単位で表示
- 入力テーブル：日付×項目（防護服/手袋/吸収缶）
- データがない日は「-」でグレーアウト

#### 集計画面（/summary）
- 照合結果一覧（入力値 vs Excel値）
- ステータス表示
  - ✓ OK（緑）：一致
  - ⚠ 要確認（オレンジ）：不一致
  - - 未入力（グレー）
- ⚠にホバーで内訳表示（さ5 / 竹3 / リ2）
- PDF出力ボタン

---

## 3. データの流れ

### Excel読み込み（excelUtils.ts）

```
Excelファイル
    ↓
シート名で対応を判定
  - 「防護服」シート → bogoufuku
  - 「防護手袋」シート → tebukuro
  - 「フィルター」シート → kyuushukan
    ↓
7行目以降のデータを読み取り
  - 列0: 日付
  - 列3: 使用数
    ↓
日付ごとに3項目の値を格納
```

### 状態管理（AppContext.tsx）

アプリ全体の状態をContext APIで管理。ローカルストレージに自動保存される。

| 状態 | 説明 |
|------|------|
| vendors | 業者リスト |
| excelData | Excel読み込みデータ（日付と値） |
| inputs | ユーザー入力値（日付×業者×項目） |
| lastSaved | 最終保存日時 |

**保存キー**: `bougu-check-data`

### 照合ロジック（summary/page.tsx）

```
各日付・各項目について：
  入力値 = さくら + 竹内 + リバーランズ
  Excel値 = excelData.values[日付][項目]
  
  結果:
    入力値 === Excel値 → OK
    入力値 !== Excel値 → 要確認
    入力なし → 未入力
```

---

## 4. セットアップ手順

### 開発環境

```bash
# 依存関係インストール
cd bougu-check-app
npm install

# 開発サーバー起動
npm run dev

# ブラウザで http://localhost:3000 を開く
```

### 本番デプロイ（Vercel）

```bash
# ビルド
npm run build

# または Vercel CLI
vercel deploy
```

---

## 5. カスタマイズポイント

### 業者名の変更
`AppContext.tsx` の `defaultVendors` を編集

```typescript
const defaultVendors: Vendor[] = [
  { id: '1', name: 'さくら塗装' },
  { id: '2', name: '竹内塗装' },
  { id: '3', name: 'リバーランズ' },
];
```

### Excel列の変更
`excelUtils.ts` の読み取り位置を編集

```typescript
// 現在: 7行目以降、列3が使用数
for (let i = 6; i < rows.length; i++) {
  const usageValue = row[3];  // ← この数字を変更
}
```

### 項目名の対応変更
`excelUtils.ts` の `ITEM_CONFIG` を編集

```typescript
const ITEM_CONFIG = {
  bogoufuku: { excelSheetName: '防護服' },
  tebukuro: { excelSheetName: '防護手袋' },
  kyuushukan: { excelSheetName: 'フィルター' },
};
```

---

## 6. トラブルシューティング

| 症状 | 原因・対処 |
|------|-----------|
| Excelが読み込めない | シート名が「防護服」「防護手袋」「フィルター」か確認 |
| 日付が表示されない | Excel側で使用数列（列D）に数字がない日はスキップされる |
| データが消えた | ブラウザのローカルストレージを確認。「クリア」ボタンで削除済みの可能性 |
| オーバーレイの線がずれる | 人数設定を確認。位置は↑↓キーで微調整 |

---

## 7. 今後の改善案

- [ ] Excel修正機能（集計画面からExcel値を直接修正）
- [ ] PDFプレビューを入力画面に統合
- [ ] 複数現場対応（プロジェクト切り替え）
- [ ] クラウド保存（Firebase等）
